name: Update Formula

on:
  repository_dispatch:
    types: [pypi-release]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to update to (leave empty for latest)"
        required: false

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      HOMEBREW_NO_AUTO_UPDATE: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
    steps:
      - uses: actions/checkout@v4

      - name: Add Homebrew to PATH
        run: echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"

      - name: Get latest PyPI info
        id: pypi
        run: |
          INFO=$(curl -s https://pypi.org/pypi/summon-claude/json)
          VERSION=$(echo "$INFO" | jq -r '.info.version')
          SDIST_URL=$(echo "$INFO" | jq -r '.urls[] | select(.packagetype=="sdist") | .url')
          SDIST_SHA=$(echo "$INFO" | jq -r '.urls[] | select(.packagetype=="sdist") | .digests.sha256')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "url=$SDIST_URL" >> "$GITHUB_OUTPUT"
          echo "sha256=$SDIST_SHA" >> "$GITHUB_OUTPUT"

      - name: Write formula skeleton
        run: |
          cat > Formula/summon-claude.rb << RUBY
          class SummonClaude < Formula
            include Language::Python::Virtualenv

            desc "Bridge Claude Code sessions to Slack channels"
            homepage "https://github.com/wgordon17/summon-claude"
            url "${{ steps.pypi.outputs.url }}"
            sha256 "${{ steps.pypi.outputs.sha256 }}"
            license "MIT"

            depends_on "python@3.13"
            depends_on "rust" => :build

            def install
              virtualenv_install_with_resources
            end

            test do
              assert_match "summon, version", shell_output("#{bin}/summon version")
            end
          end
          RUBY

      - name: Tap and generate resources
        run: |
          brew tap wgordon17/summon .
          brew update-python-resources summon-claude
          cp "$(brew formula summon-claude)" Formula/summon-claude.rb
          brew audit --strict summon-claude

      - name: Commit and push
        run: |
          git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/summon-claude.rb
          if git diff --cached --quiet; then
            echo "No changes to formula"
            exit 0
          fi
          git commit -m "Update summon-claude to ${{ steps.pypi.outputs.version }}"
          git push origin main
